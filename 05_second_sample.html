<!DOCTYPE html>
<html>
  <head>
    <title>A-Frame Maze</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script>window.THREE.Math = window.THREE.MathUtils;</script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <script>
      // ゴール判定用のカスタムコンポーネント
      AFRAME.registerComponent('goal-detector', {
        init: function () {
          this.player = document.querySelector('#rig');
          this.cleared = false;
        },
        tick: function () {
          if (this.cleared) return;
          
          // プレイヤーとゴールの位置を取得
          const playerPos = this.player.object3D.position;
          const goalPos = this.el.object3D.position;

          // 距離（XZ平面）を計算
          const dist = Math.sqrt(
            Math.pow(playerPos.x - goalPos.x, 2) + 
            Math.pow(playerPos.z - goalPos.z, 2)
          );

          // 1.5メートル以内に近づいたらゴール！
          if (dist < 1.5) {
            this.cleared = true;
            this.celebrate();
          }
        },
        celebrate: function () {
          // 1. 空の色をお祝いカラー（ピンク/金）に変える
          document.querySelector('a-sky').setAttribute('animation', {
            property: 'color',
            to: '#ff69b4',
            dur: 1000
          });

          // 2. クリアメッセージを表示
          const msg = document.querySelector('#clear-text');
          msg.setAttribute('visible', 'true');
          msg.setAttribute('animation', {
            property: 'scale',
            from: '0 0 0',
            to: '1 1 1',
            dur: 1000,
            easing: 'easeOutElastic'
          });

          // 3. ゴールオブジェクトを巨大化させて回転を速める
          this.el.setAttribute('animation__scale', {
            property: 'scale',
            to: '3 3 3',
            dur: 1000
          });
          this.el.querySelector('a-box').setAttribute('animation', 'dur: 500'); // 回転を速く
        }
      });
    </script>
  </head>
  <body>
    <a-scene physics="debug: false">
      <a-assets>
        <a-mixin id="wall" geometry="primitive: box; width: 2; height: 3; depth: 2" material="color: #f5f5f5" static-body></a-mixin>
      </a-assets>

      <a-entity id="rig" movement-controls="speed: 0.2" kinematic-body="radius: 0.4" position="2 0.1 2">
        <a-entity camera position="0 1.6 0" look-controls="pointerLockEnabled: true">
          <a-cursor color="#333" scale="0.5 0.5 0.5"></a-cursor>
          
          <a-entity id="clear-text" position="0 0 -2" visible="false" scale="0 0 0">
            <a-text value="CONGRATULATIONS!" align="center" color="#FFF" width="6"></a-text>
            <a-plane color="#000" opacity="0.6" width="4" height="1" position="0 0 -0.1"></a-plane>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-box position="10 -0.5 10" width="40" height="1" depth="40" color="#8b4513" static-body></a-box>
      <a-sky id="sky" color="#ecf0f1"></a-sky>

      <a-light type="ambient" intensity="0.7"></a-light>
      <a-light type="directional" position="1 4 3" intensity="0.5"></a-light>

      <a-entity id="goal-marker" goal-detector>
        <a-box color="#f1c40f" position="0 0.5 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear"></a-box>
        <a-light type="point" color="#f1c40f" intensity="2" distance="4"></a-light>
        <a-text value="GOAL" position="0 1.5 0" align="center" color="#f39c12" scale="3 3 3"></a-text>
      </a-entity>

      <a-entity id="maze-container"></a-entity>
    </a-scene>

    <script>
      const SIZE = 13;
      const maze = Array.from({ length: SIZE }, () => Array(SIZE).fill(1));
      function generateMaze(x, y) {
        maze[y][x] = 0;
        const dirs = [[0, 2], [0, -2], [2, 0], [-2, 0]].sort(() => Math.random() - 0.5);
        for (let [dx, dy] of dirs) {
          const nx = x + dx, ny = y + dy;
          if (nx > 0 && nx < SIZE - 1 && ny > 0 && ny < SIZE - 1 && maze[ny][nx] === 1) {
            maze[y + dy / 2][x + dx / 2] = 0;
            generateMaze(nx, ny);
          }
        }
      }
      generateMaze(1, 1);

      const container = document.getElementById('maze-container');
      for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
          if (maze[y][x] === 1) {
            const wall = document.createElement('a-entity');
            wall.setAttribute('mixin', 'wall');
            wall.setAttribute('position', `${x * 2} 1.5 ${y * 2}`);
            container.appendChild(wall);
          }
        }
      }
      document.getElementById('goal-marker').setAttribute('position', `${(SIZE - 2) * 2} 0.5 ${(SIZE - 2) * 2}`);
    </script>
  </body>
</html>
